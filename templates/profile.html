{% extends "base.html" %}

{% block title %}Profile - Social Contract{% endblock %}

{% block meta_description %}Your profile, stats, and activity history on Social Contract.{% endblock %}

{% block content %}
<div class="profile-page">
    <header class="profile-header">
        <div class="profile-avatar-wrapper">
            {% if user.profile_photo %}
                <img src="{{ user.profile_photo }}" alt="{{ user.display_name }}" class="profile-avatar-large avatar-img">
            {% else %}
                <div class="profile-avatar-large">{{ safe_initial(user.display_name) }}</div>
            {% endif %}
            <label for="photo-upload" class="avatar-upload-btn" title="Change photo">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
            </label>
        </div>
        <form action="{{ url_for('upload_profile_photo_route') }}" method="POST" enctype="multipart/form-data" id="photo-upload-form" style="display:none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" id="photo-upload" name="photo" accept="image/png,image/jpeg,image/gif,image/webp">
        </form>
        {% if user.profile_photo %}
        <form action="{{ url_for('remove_profile_photo') }}" method="POST" class="remove-photo-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-ghost btn-sm remove-photo-btn">Remove photo</button>
        </form>
        {% endif %}
        <p class="profile-photo-hint">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -1px;">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Your photo is visible to other challenge members
        </p>
        <h1 class="page-title" id="profile-display-name">{{ user.display_name }}</h1>
        <p class="profile-username">@{{ user.username }}</p>
        <p class="profile-joined">Member since {{ user.created_at.strftime('%Y-%m-%d') }}</p>
        <button type="button" class="btn btn-ghost btn-sm edit-profile-toggle" id="edit-profile-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Edit Profile
        </button>
    </header>

    <!-- Edit Profile Form (hidden by default) -->
    <section class="edit-profile-section" id="edit-profile-section" style="display: none;">
        <form action="{{ url_for('edit_profile') }}" method="POST" class="edit-profile-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="edit-profile-fields">
                <div class="form-group">
                    <label for="edit-display-name" class="form-label">Display Name</label>
                    <input type="text" id="edit-display-name" name="display_name" value="{{ user.display_name }}" class="form-input" maxlength="50" required>
                </div>
                <div class="form-group">
                    <label for="edit-timezone" class="form-label">Timezone</label>
                    <select id="edit-timezone" name="timezone" class="form-input">
                        <option value="UTC" {% if user.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                        <option value="America/New_York" {% if user.timezone == 'America/New_York' %}selected{% endif %}>Eastern Time (US)</option>
                        <option value="America/Chicago" {% if user.timezone == 'America/Chicago' %}selected{% endif %}>Central Time (US)</option>
                        <option value="America/Denver" {% if user.timezone == 'America/Denver' %}selected{% endif %}>Mountain Time (US)</option>
                        <option value="America/Los_Angeles" {% if user.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time (US)</option>
                        <option value="America/Anchorage" {% if user.timezone == 'America/Anchorage' %}selected{% endif %}>Alaska Time</option>
                        <option value="Pacific/Honolulu" {% if user.timezone == 'Pacific/Honolulu' %}selected{% endif %}>Hawaii Time</option>
                        <option value="Europe/London" {% if user.timezone == 'Europe/London' %}selected{% endif %}>London (GMT/BST)</option>
                        <option value="Europe/Paris" {% if user.timezone == 'Europe/Paris' %}selected{% endif %}>Central European</option>
                        <option value="Europe/Helsinki" {% if user.timezone == 'Europe/Helsinki' %}selected{% endif %}>Eastern European</option>
                        <option value="Asia/Dubai" {% if user.timezone == 'Asia/Dubai' %}selected{% endif %}>Dubai (GST)</option>
                        <option value="Asia/Kolkata" {% if user.timezone == 'Asia/Kolkata' %}selected{% endif %}>India (IST)</option>
                        <option value="Asia/Shanghai" {% if user.timezone == 'Asia/Shanghai' %}selected{% endif %}>China (CST)</option>
                        <option value="Asia/Tokyo" {% if user.timezone == 'Asia/Tokyo' %}selected{% endif %}>Japan (JST)</option>
                        <option value="Australia/Sydney" {% if user.timezone == 'Australia/Sydney' %}selected{% endif %}>Sydney (AEST)</option>
                        <option value="Pacific/Auckland" {% if user.timezone == 'Pacific/Auckland' %}selected{% endif %}>New Zealand (NZST)</option>
                    </select>
                </div>
            </div>
            <div class="edit-profile-actions">
                <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
                <button type="button" class="btn btn-ghost btn-sm" id="cancel-edit-btn">Cancel</button>
            </div>
        </form>
    </section>

    <div class="profile-stats stats-grid">
        <div class="stat-card">
            <div class="stat-icon">&#127942;</div>
            <div class="stat-info">
                <span class="stat-value" data-count="{{ stats.total_points or 0 }}">{{ stats.total_points or 0 }}</span>
                <span class="stat-label">Total Points</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">&#9989;</div>
            <div class="stat-info">
                <span class="stat-value" data-count="{{ stats.total_checkins or 0 }}">{{ stats.total_checkins or 0 }}</span>
                <span class="stat-label">Total Check-ins</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">&#128293;</div>
            <div class="stat-info">
                <span class="stat-value" data-count="{{ stats.best_streak or 0 }}">{{ stats.best_streak or 0 }}</span>
                <span class="stat-label">Best Streak</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">&#9876;&#65039;</div>
            <div class="stat-info">
                <span class="stat-value" data-count="{{ stats.total_challenges or 0 }}">{{ stats.total_challenges or 0 }}</span>
                <span class="stat-label">Challenges Joined</span>
            </div>
        </div>
    </div>

    <!-- Weekly Digest -->
    <section class="dashboard-section">
        <div class="section-header">
            <h2>This Week</h2>
        </div>
        <div class="weekly-digest">
            <div class="digest-card">
                <span class="digest-value">{{ weekly_digest.checkins }}</span>
                <span class="digest-label">Check-ins</span>
                {% if weekly_digest.checkins_change > 0 %}
                <span class="digest-change positive">+{{ weekly_digest.checkins_change }} vs last week</span>
                {% elif weekly_digest.checkins_change < 0 %}
                <span class="digest-change negative">{{ weekly_digest.checkins_change }} vs last week</span>
                {% else %}
                <span class="digest-change neutral">Same as last week</span>
                {% endif %}
            </div>
            <div class="digest-card">
                <span class="digest-value">{{ weekly_digest.checkin_rate }}%</span>
                <span class="digest-label">Consistency Rate</span>
                <span class="digest-change neutral">Last 7 days</span>
            </div>
        </div>
    </section>

    <!-- Activity Heatmap -->
    <section class="profile-section">
        <h2>Activity (Last 30 Days)</h2>
        <div class="heatmap-grid">
            {% for day in calendar_days %}
            <div class="heatmap-cell level-{% if day.count == 0 %}0{% elif day.count == 1 %}1{% elif day.count == 2 %}2{% elif day.count <= 4 %}3{% else %}4{% endif %}{% if day.is_today %} today{% endif %}" title="{{ day.date }}: {{ day.count }} check-in(s)"></div>
            {% endfor %}
        </div>
        <div class="heatmap-legend">
            <span class="heatmap-legend-label">Less</span>
            <div class="heatmap-cell level-0 legend-cell"></div>
            <div class="heatmap-cell level-1 legend-cell"></div>
            <div class="heatmap-cell level-2 legend-cell"></div>
            <div class="heatmap-cell level-3 legend-cell"></div>
            <div class="heatmap-cell level-4 legend-cell"></div>
            <span class="heatmap-legend-label">More</span>
        </div>
    </section>

    <!-- Achievements -->
    {% if achievements %}
    <section class="profile-section">
        <div class="section-header">
            <h2>Achievements</h2>
            <a href="{{ url_for('achievements_page') }}" class="btn btn-ghost btn-sm">View All</a>
        </div>
        <div class="achievements-mini-grid">
            {% for achievement in achievements[:6] %}
            <div class="achievement-mini">
                <div class="achievement-mini-icon">&#127942;</div>
                <span class="achievement-mini-name">{{ achievement.name }}</span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <section class="profile-section">
        <h2>Quick Actions</h2>
        <div class="quick-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-ghost">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Go to Dashboard
            </a>
            <a href="{{ url_for('create_challenge') }}" class="btn btn-ghost">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="16"></line>
                    <line x1="8" y1="12" x2="16" y2="12"></line>
                </svg>
                Create Challenge
            </a>
            <form action="{{ url_for('logout') }}" method="POST" class="logout-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-danger">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Log Out
                </button>
            </form>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var editBtn = document.getElementById('edit-profile-btn');
    var cancelBtn = document.getElementById('cancel-edit-btn');
    var section = document.getElementById('edit-profile-section');

    if (editBtn && section) {
        editBtn.addEventListener('click', function() {
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            if (section.style.display === 'block') {
                section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }
    if (cancelBtn && section) {
        cancelBtn.addEventListener('click', function() {
            section.style.display = 'none';
        });
    }

    // Auto-detect timezone for the select
    var tzSelect = document.getElementById('edit-timezone');
    if (tzSelect && !tzSelect.value) {
        try {
            var detected = Intl.DateTimeFormat().resolvedOptions().timeZone;
            for (var i = 0; i < tzSelect.options.length; i++) {
                if (tzSelect.options[i].value === detected) {
                    tzSelect.value = detected;
                    break;
                }
            }
        } catch(e) {}
    }
})();
</script>
{% endblock %}
