<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}Social Contract{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Build habits through accountability challenges with friends. Daily check-ins, streaks, and leaderboards.{% endblock %}">

    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}{{ self.title() }}{% endblock %}">
    <meta property="og:description" content="{{ self.meta_description() }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Social Contract">
    <meta property="og:image" content="{{ url_for('static', filename='icons/icon-512.png', _external=True) }}">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="{{ self.title() }}">
    <meta name="twitter:description" content="{{ self.meta_description() }}">
    <meta name="twitter:image" content="{{ url_for('static', filename='icons/icon-512.png', _external=True) }}">

    <meta name="view-transition" content="same-origin">

    <!-- PWA -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Social Contract">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16.png') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://res.cloudinary.com" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>
</head>
<body>
    {% if session.user_id %}
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('dashboard') }}" class="nav-logo">
                <span class="logo-icon">&#9876;&#65039;</span>
                <span class="logo-text">Social Contract</span>
            </a>

            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu" aria-controls="nav-links" aria-expanded="false">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>

            <div class="nav-links" id="nav-links">
                <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Dashboard
                </a>
                <a href="{{ url_for('explore') }}" class="nav-link {% if request.endpoint == 'explore' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    Explore
                </a>
                <a href="{{ url_for('create_challenge') }}" class="nav-link {% if request.endpoint == 'create_challenge' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                    Create
                </a>
                <a href="{{ url_for('join_challenge') }}" class="nav-link {% if request.endpoint == 'join_challenge' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Join
                </a>
                <a href="{{ url_for('achievements_page') }}" class="nav-link {% if request.endpoint == 'achievements_page' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"></circle>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    Achievements
                </a>
                {% if is_admin() %}
                <a href="{{ url_for('analytics_dashboard') }}" class="nav-link {% if request.endpoint == 'analytics_dashboard' %}active{% endif %}">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"></path>
                        <path d="M7 14l3-3 3 2 4-5"></path>
                    </svg>
                    Analytics
                </a>
                {% endif %}
            </div>

            <div class="nav-user">
                <a href="{{ url_for('notifications_page') }}" class="notif-bell {% if request.endpoint == 'notifications_page' %}active{% endif %}" title="Notifications">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="notif-badge" id="notif-badge" style="display:none">0</span>
                </a>
                <a href="{{ url_for('profile') }}" class="user-link {% if request.endpoint == 'profile' %}active{% endif %}">
                    {% if session.profile_photo %}
                        <img src="{{ session.profile_photo }}" alt="{{ session.display_name }}" class="user-avatar avatar-img">
                    {% else %}
                        <div class="user-avatar">{{ session.display_name[0]|upper }}</div>
                    {% endif %}
                    <span class="user-name">{{ session.display_name }}</span>
                </a>
                <form action="{{ url_for('logout') }}" method="POST" class="logout-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="logout-btn" title="Logout">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </nav>
    {% endif %}

    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages" aria-live="polite" aria-atomic="true">
                    {% for category, message in messages %}
                        <div class="flash flash-{{ category }}" role="status">
                            {% if category == 'success' %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            {% else %}
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                            {% endif %}
                            <span>{{ message }}</span>
                            <button class="flash-close" aria-label="Dismiss message">x</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    {% if session.user_id %}
    <nav class="bottom-tab-bar">
        <a href="{{ url_for('dashboard') }}" class="tab-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span>Home</span>
        </a>
        <a href="{{ url_for('explore') }}" class="tab-item {% if request.endpoint == 'explore' %}active{% endif %}">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="M21 21l-4.35-4.35"></path>
            </svg>
            <span>Explore</span>
        </a>
        <a href="{{ url_for('create_challenge') }}" class="tab-item tab-create {% if request.endpoint == 'create_challenge' %}active{% endif %}">
            <div class="tab-create-icon">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
            <span>Create</span>
        </a>
        <a href="{{ url_for('notifications_page') }}" class="tab-item {% if request.endpoint == 'notifications_page' %}active{% endif %}">
            <div class="tab-notif-wrap">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span class="tab-notif-badge" id="tab-notif-badge" style="display:none"></span>
            </div>
            <span>Alerts</span>
        </a>
        <a href="{{ url_for('profile') }}" class="tab-item {% if request.endpoint == 'profile' %}active{% endif %}">
            {% if session.profile_photo %}
                <img src="{{ session.profile_photo }}" alt="" class="tab-avatar">
            {% else %}
                <div class="tab-avatar">{{ session.display_name[0]|upper }}</div>
            {% endif %}
            <span>Profile</span>
        </a>
    </nav>
    {% endif %}

    <script src="{{ url_for('static', filename='script.js') }}" defer></script>
    <script src="{{ url_for('static', filename='perf-metrics.js') }}" defer></script>
    {% block scripts %}{% endblock %}
</body>
</html>
